(self.webpackChunklorcana_deck_generator=self.webpackChunklorcana_deck_generator||[]).push([[745],{495:(e,t,s)=>{"use strict";var n=s(947),a=s(122);class i{constructor(){this.model=null,this.vocabSize=0,this.featureDim=0,this.maxLen=60,this.embeddingDim=32,this.lstmUnits=64,this.textVocabSize=0,this.maxTextTokens=0,this.textEmbeddingDim=16}async initialize(e,t,s,n){this.vocabSize=e+1,this.featureDim=t,this.textVocabSize=s,this.maxTextTokens=n;const i=a.hFB({shape:[this.maxLen],dtype:"int32",name:"input_indices"}),o=a.hFB({shape:[this.maxLen,this.featureDim],dtype:"float32",name:"input_features"}),r=a.hFB({shape:[this.maxLen,this.maxTextTokens],dtype:"int32",name:"input_text_tokens"}),l=a.ZFI.embedding({inputDim:this.vocabSize,outputDim:this.embeddingDim,inputLength:this.maxLen,name:"embedding"}).apply(i),h=a.ZFI.embedding({inputDim:this.textVocabSize,outputDim:this.textEmbeddingDim,name:"text_embedding"}).apply(r),d=a.ZFI.reshape({targetShape:[this.maxLen,this.maxTextTokens*this.textEmbeddingDim],name:"text_flatten"}).apply(h),c=a.ZFI.dense({units:this.textEmbeddingDim,activation:"relu",name:"text_projection"}).apply(d),m=a.ZFI.concatenate({name:"concat_all_features"}).apply([l,o,c]),u=a.ZFI.lstm({units:this.lstmUnits,returnSequences:!1,name:"lstm"}).apply(m),p=a.ZFI.dense({units:this.vocabSize,activation:"softmax",name:"output"}).apply(u);this.model=a.geq({inputs:[i,o,r],outputs:p,name:"deck_predictor"}),this.model.compile({optimizer:a.BaG.adam(.001),loss:"sparseCategoricalCrossentropy",metrics:["accuracy"]}),this.model.summary()}async train(e,t,s,n){console.warn("Browser training with text embeddings not fully implemented yet")}prepareData(e,t){return{}}async predict(e,t,s){if(!this.model)return null;const n=Array(this.maxLen).fill(0),i=Math.max(0,this.maxLen-e.length);for(let t=0;t<Math.min(e.length,this.maxLen);t++)n[i+t]=e[t];const o=[];for(let e=0;e<this.maxLen;e++)o.push(Array(this.featureDim).fill(0));for(let e=0;e<Math.min(t.length,this.maxLen);e++)o[i+e]=t[e];!this.maxTextTokens&&this.model.inputs[2]&&(this.maxTextTokens=this.model.inputs[2].shape[2]);const r=this.maxTextTokens||20,l=[];for(let e=0;e<this.maxLen;e++)l.push(Array(r).fill(0));if(s)for(let e=0;e<Math.min(s.length,this.maxLen);e++)l[i+e]=s[e];const h=a.KtR([n],[1,this.maxLen]),d=a.$_$([o],[1,this.maxLen,this.featureDim]),c=a.$_$([l],[1,this.maxLen,r]),m=this.model.predict([h,d,c]),u=await m.data();return h.dispose(),d.dispose(),c.dispose(),m.dispose(),u}async saveModel(e){this.model&&await this.model.save(e)}async loadModel(e){this.model=await a.O0W(e),this.model.compile({optimizer:"adam",loss:"sparseCategoricalCrossentropy",metrics:["accuracy"]}),this.model.inputs&&this.model.inputs.length>1&&(this.featureDim=this.model.inputs[1].shape[2]),this.model.inputs&&this.model.inputs.length>2&&(this.maxTextTokens=this.model.inputs[2].shape[2]),this.model.summary()}}class o{constructor(){this.tokenToIndex={"<PAD>":0,"<UNK>":1},this.indexToToken={0:"<PAD>",1:"<UNK>"},this.vocabularySize=2,this.maxTextTokens=30,this.allCardNames=[]}load(e){this.tokenToIndex=e.tokenToIndex,this.indexToToken=e.indexToToken,this.vocabularySize=e.vocabularySize,this.maxTextTokens=e.maxTextTokens,this.allCardNames=e.allCardNames||[],console.log(`Vocabulary loaded (${this.vocabularySize} tokens)`)}cleanText(e){if(!e)return"";let t=e.toLowerCase();return t=t.replace(/\{e\}/g," exert "),t=t.replace(/[^a-z0-9\s+\{\}]/g,""),t.trim()}extractTextTokens(e,t){const s=[];let n=this.cleanText(e);t.forEach((e=>{n.includes(e)&&(s.push(e),n=n.replace(new RegExp(e,"g")," "))}));const a=n.split(/\s+/).map((e=>e.trim())).filter((e=>e.length>2||"+"===e||"{"===e||"}"===e));return s.push(...a),s}cardToTextIndices(e){const t=[],s=this.cleanText(e.name);if(s&&void 0!==this.tokenToIndex[s]&&t.push(this.tokenToIndex[s]),e.keywords&&Array.isArray(e.keywords)&&e.keywords.forEach((e=>{const s=this.cleanText(e),n=this.tokenToIndex[s]||this.tokenToIndex["<UNK>"];t.push(n)})),e.ink){const s=this.cleanText(e.ink),n=this.tokenToIndex[s]||this.tokenToIndex["<UNK>"];t.push(n)}e.classifications&&Array.isArray(e.classifications)&&e.classifications.forEach((e=>{const s=this.cleanText(e),n=this.tokenToIndex[s]||this.tokenToIndex["<UNK>"];t.push(n)})),e.types&&Array.isArray(e.types)?e.types.forEach((e=>{const s=this.cleanText(e),n=this.tokenToIndex[s]||this.tokenToIndex["<UNK>"];t.push(n)})):e.type&&Array.isArray(e.type)&&e.type.forEach((e=>{const s=this.cleanText(e),n=this.tokenToIndex[s]||this.tokenToIndex["<UNK>"];t.push(n)}));let n=e.sanitizedText;return!n&&e.text&&(n=e.text.toLowerCase().replace(/\([^)]+\)/g,"").replace(/\(|\)/g,"").trim()),n&&this.extractTextTokens(n,this.allCardNames).slice(0,10).forEach((e=>{const s=this.tokenToIndex[e]||this.tokenToIndex["<UNK>"];t.push(s)})),this.padOrTruncate(t,this.maxTextTokens)}padOrTruncate(e,t){if(e.length>=t)return e.slice(0,t);const s=[...e];for(;s.length<t;)s.push(0);return s}}class r{constructor(){this.cardApi=new n.A,this.model=new i,this.textEmbedder=new o,this.cards=[],this.cardMap=new Map,this.indexMap=new Map}getCardKey(e,t){return t?`${e} - ${t}`:e}async loadCards(){return 0===this.cards.length&&(this.cards=await this.cardApi.getCards(),this.cards.forEach((e=>{const t=this.getCardKey(e.name,e.version);if(!this.cardMap.has(t)){const s=this.cardMap.size;this.cardMap.set(t,s),this.indexMap.set(s,e)}}))),this.cards}async loadModel(e){await this.loadCards();try{const e=await fetch("training_data/vocabulary.json");if(e.ok){const t=await e.json();this.textEmbedder.load(t)}else console.error("Failed to load vocabulary.json")}catch(e){console.error("Error loading vocabulary:",e)}await this.model.loadModel(e)}async predict(e,t=!0,s=[]){const n=[],a=[],i=[];let o=this.getInitialDeckStats();e.forEach((e=>{let t=null;if(e.includes(" - ")){const s=e.split(" - "),n=s[0].trim(),a=s.slice(1).join(" - ").trim(),i=this.getCardKey(n,a);this.cardMap.has(i)&&(t=this.cardMap.get(i))}if(null===t){const s=e.trim().toLowerCase();for(const[e,n]of this.cardMap.entries())if(e.toLowerCase().startsWith(s)){t=n;break}}if(null!==t){n.push(t);const e=this.indexMap.get(t);this.updateDeckStats(o,e);const s=n.filter((e=>e===t)).length-1,r=this.extractCardFeatures(e,o,s),l=this.textEmbedder.cardToTextIndices(e);a.push(r),i.push(l)}}));const r=new Map,l=new Set;n.forEach((e=>{r.set(e,(r.get(e)||0)+1);const t=this.indexMap.get(e);t&&t.ink&&l.add(t.ink)}));const h=await this.model.predict(n,a,i),d=this.getAdaptiveTemperature(n.length),c=this.sampleTopP(h,d,.9),m=Array.from(h).map(((e,t)=>({index:t,prob:e}))).sort(((e,t)=>t.prob-e.prob)),u=[c,...m.map((e=>e.index)).filter((e=>e!==c))];for(const e of u){const n=this.indexMap.get(e);if(n&&!(t&&"legal"!==n.legality||(r.get(e)||0)>=(n.maxAmount||4))){if(s.length>0&&!(n.inks||(n.ink?[n.ink]:[])).every((e=>s.includes(e))))continue;if(!(l.size>=2)||l.has(n.ink))return n}}return null}getAdaptiveTemperature(e){return e<=10?2:e<=40?1:.8}sampleTopP(e,t=1,s=.9){const n=Array.from(e).map(((e,s)=>({prob:Math.pow(Math.max(e,1e-10),1/t),index:s}))),a=n.reduce(((e,t)=>e+t.prob),0);n.forEach((e=>e.prob/=a)),n.sort(((e,t)=>t.prob-e.prob));let i=0;const o=[];for(const e of n)if(i+=e.prob,o.push(e),i>=s)break;0===o.length&&o.push(n[0]);const r=o.reduce(((e,t)=>e+t.prob),0),l=Math.random()*r;let h=0;for(const e of o)if(h+=e.prob,l<=h)return e.index;return o[o.length-1].index}getInitialDeckStats(){return{totalCards:0,inkableCount:0,costCounts:[0,0,0,0,0,0,0,0,0,0],inkableCostCounts:[0,0,0,0,0,0,0,0,0,0],typeCounts:{character:0,action:0,item:0,location:0},inkCounts:{Amber:0,Amethyst:0,Emerald:0,Ruby:0,Sapphire:0,Steel:0}}}updateDeckStats(e,t){e.totalCards++,t.inkwell&&e.inkableCount++;let s=Math.max(0,Math.min(t.cost-1,9));if(0===t.cost&&(s=0),e.costCounts[s]++,t.inkwell&&e.inkableCostCounts[s]++,t.ink&&(e.inkCounts[t.ink]||(e.inkCounts[t.ink]=0),e.inkCounts[t.ink]++),t.type){const s=t.type.toLowerCase();void 0!==e.typeCounts[s]&&e.typeCounts[s]++}}extractCardFeatures(e,t,s=0){const n=[];n.push(Math.min(e.cost,10)/10),n.push(e.inkwell?1:0),n.push(Math.min(e.lore||0,5)/5),n.push(Math.min(e.strength||0,10)/10),n.push(Math.min(e.willpower||0,10)/10),["Amber","Amethyst","Emerald","Ruby","Sapphire","Steel"].forEach((t=>{n.push(e.ink===t?1:0)}));const a=e.types&&e.types.length>0?e.types[0]:"";["Character","Action","Item","Location"].forEach((e=>{n.push(a===e?1:0)})),["Bodyguard","Reckless","Rush","Ward","Evasive","Resist","Challenger","Singer","Shift","Boost"].forEach((t=>{const s=`has${t}`;if(void 0!==e[s])n.push(e[s]?1:0);else{const s=e.keywords&&e.keywords.some((e=>e.includes(t)));n.push(s?1:0)}})),n.push(Math.min(e.resistAmount||0,10)/10),n.push(Math.min(e.challengerAmount||0,10)/10),n.push(Math.min(e.boostAmount||0,10)/10),n.push(Math.min(e.moveCost||0,10)/10),["Hero","Villain","Dreamborn","Storyborn","Floodborn"].forEach((t=>{n.push(e.classifications&&e.classifications.includes(t)?1:0)})),n.push(Math.min(s,4)/4);const i=Math.max(1,t.totalCards);return n.push(t.inkableCount/i),t.costCounts.forEach((e=>{n.push(e/i)})),Object.values(t.typeCounts).forEach((e=>{n.push(e/i)})),["Amber","Amethyst","Emerald","Ruby","Sapphire","Steel"].forEach((e=>{n.push((t.inkCounts[e]||0)/i)})),t.inkableCostCounts.forEach((e=>{n.push(e/i)})),n}getCardByName(e){let t=null;if(e.includes(" - ")){const s=e.split(" - "),n=s[0].trim(),a=s.slice(1).join(" - ").trim(),i=this.getCardKey(n,a);this.cardMap.has(i)&&(t=this.cardMap.get(i))}if(null===t){const s=e.trim().toLowerCase();for(const[e,n]of this.cardMap.entries())if(e.toLowerCase().startsWith(s)){t=n;break}}return null!==t?this.indexMap.get(t):null}}var l=s(238),h=s(795),d=s(814),c=s(479),m=s(844);document.addEventListener("DOMContentLoaded",(async()=>{const e=new r,t=document.getElementById("generate-deck-btn"),s=document.getElementById("test-deck-btn"),n=document.getElementById("clear-deck-btn"),a=document.querySelector('[data-role="chart"]'),i=document.getElementById("legal-only"),o=new l.A(a);let u,p,x,f,k=[],g=[];f=new m.A;const y=document.querySelector('[data-role="deck"]');p=new d.A(y,{onRemove:e=>{const t=k.findIndex((t=>t.id===e));-1!==t&&(k.splice(t,1),T(),u.refresh())},onAdd:()=>u.show(),onCardClick:e=>f.show(e.image,e.name),isEditable:!0,showAddPlaceholder:!0}),x=new c.A(document.querySelector('[data-role="ink-selector"]'),{onChange:e=>{g=e;const t=k.filter((e=>g.includes(e.ink)||b(e,g)));t.length!==k.length&&(k=t,T()),u&&u.refresh()}}),T();try{console.log("Loading AI model..."),await e.loadModel("training_data/deck-generator-model/model.json"),console.log("Model loaded successfully!"),u=new h.A(e.cards,document.querySelector("[data-role=card-select]"),(e=>function(e){if(k.length>=60)return void alert("Deck is full (60 cards).");k.filter((t=>t.id===e.id)).length>=4?alert("Cannot add more than 4 copies of a card."):(k.push(e),T(),u.refresh())}(e)),{filter:e=>!(g.length>0&&!g.includes(e.ink)&&!b(e,g))&&k.filter((t=>t.id===e.id)).length<4,renderButtonText:e=>`Add Card (${k.filter((t=>t.id===e.id)).length}/4)`}),t.disabled=!1}catch(e){console.error("Failed to load model:",e),alert("Failed to load AI model. Please refresh the page.")}function b(e,t){return!(2!==t.length||!e.inks)&&t.includes(e.inks[0])&&t.includes(e.inks[1])}function T(){p.render(k,g),s.classList.remove("hidden"),k.length<60&&s.classList.add("hidden"),k.length>0?o.renderChart(k):o.renderChart([])}t.addEventListener("click",(async()=>{t.disabled=!0;const s=i.checked;for(;k.length<60;){const t=k.map((e=>e.version?`${e.name} - ${e.version}`:e.name)),n=await e.predict(t,s,g);if(!n||"string"==typeof n){console.warn("No valid prediction:",n);break}k.push(n),T(),await new Promise((e=>setTimeout(e,10)))}t.disabled=!1})),n.addEventListener("click",(()=>{k=[],T(),s.classList.add("hidden")})),s.addEventListener("click",(()=>{window.open(function(){const e=Math.random().toString(36).substring(7);let t=`AI Generated Deck: ${g[0]} - ${g[1]} - ${e}`;t=encodeURIComponent(t);let s="";const n=[...new Set(k.map((e=>e.name)))];for(const e of n){const t=k.filter((t=>t.name===e)).length;s+=`${e}$${t}|`}return`https://inktable.net/lor/import?svc=dreamborn&name=${t}&id=${btoa(s)}`}(),"_blank")}))}))},817:()=>{},590:()=>{},530:()=>{},108:()=>{},551:()=>{},234:()=>{}},e=>{e.O(0,[839,122,452],(()=>e(e.s=495))),e.O()}]);