"use strict";(self.webpackChunklorcana_deck_generator=self.webpackChunklorcana_deck_generator||[]).push([[792],{139:(e,t,i)=>{var s=i(947);class r{calculateWeight(e,t,i,s){let r=1;return r=this.modifyWeightForInkwell(e,r),r=this.modifyWeightForAbility(e,r),r=this.modifyWeightForShiftable(e,r,t),r=this.modifyWeightForShift(e,r,t),r=this.modifyWeightByEffect(e,r),r=this.modifyWeightByKeywords(e,r),r=this.modifyWeightForSinger(e,r,t),r=this.modifyWeightForSong(e,r,t),r=this.modifyWeightByTitlePresence(e,r,t,s),r=this.modifyWeightByRequirements(e,r,t),r=this.modifyWeightByDeckType(e,r,i),r}modifyWeightForInkwell(e,t){return e.inkwell||(t*=.85),t}modifyWeightForAbility(e,t){return void 0!==e.sanitizedText&&""!==e.sanitizedText&&null!==e.sanitizedText&&(t*=1.1),t}modifyWeightForSong(e,t,i){return e.types.includes("Song")?(t*=1.2,e.text.includes("Sing Together")&&(t*=1.05),i.filter((e=>e.types.includes("Character"))).sort(((e,t)=>e.singCost-t.singCost)).forEach((i=>{i.singCost<e.cost&&(t*=.95),i.singCost===e.cost&&(t*=1.2)})),t):t}modifyWeightForSinger(e,t,i){return e.hasSinger?(i.filter((e=>e.types.includes("Song"))).sort(((e,t)=>e.cost-t.cost)).forEach((i=>{i.cost<e.singCost&&(t*=1.1),i.cost===e.singCost&&(t*=1.15),i.text.includes("Sing Together")&&(t*=1.05)})),t):t}modifyWeightForShiftable(e,t,i){if(!e.types.includes("Character"))return t;const s=i.filter((t=>t.hasShift&&t.id!==e.id)),r=[];if(s.forEach((e=>{r.includes(e)||r.push(e)})),0===r.length)return t;for(const i of r)if(i.canShiftFrom(e)){t*=e.cost<i.cost?1.6:.95;break}return t}modifyWeightForShift(e,t,i){if(!e.hasShift)return t;if(0===i.filter((e=>e.hasShift)).length)return 1.5*t;const s=i.filter((e=>e.types.includes("Character")));for(const i of s)if(e.canShiftFrom(i)&&e.id!==i.id){t*=i.cost<e.cost?1.6:.95;break}return t}modifyWeightByTitlePresence(e,t,i,s){return i.filter((t=>t.id===e.id)).length>=e.maxAmount?0:i.filter((t=>t.id===e.id)).length>0?t*(100-s):1===i.filter((t=>t.id===e.id)).length?20*t:t}modifyWeightByRequirements(e,t,i){return e.hasRequirementsForDeck(i)&&(t*=1.8),e.deckMeetsRequirements(i)?t:.05}modifyWeightByEffect(e,t){const i=[{text:"this character can't {e} to sing songs.",modifier:.5},{text:"draw a card",modifier:1.2},{text:"draw 3 cards",modifier:1.1},{text:"draws 7 cards",modifier:1.1},{text:"banish",modifier:1.2},{text:"banish all",modifier:1.1},{text:"return",modifier:1.05},{text:"into your inkwell",modifier:1.1}];let s=!1;for(const r of i)e.sanitizedText.includes(r.text)&&(t*=r.modifier,s=!0);const r=e.sanitizedText.match(/draws? (\d+) cards/);r&&(t*=1+parseInt(r[1])/10/100,s=!0);const n=e.sanitizedText.match(/gain (\d+) lore/);return n&&(t*=1+parseInt(n[1])/10/100,s=!0),!e.types.includes("Character")||s||this.hasKeywords(e)||(t*=.5),t}hasKeywords(e){return e.hasBodyguard||e.hasEvasive||e.hasRush||e.hasWard||e.hasSinger||e.hasReckless||e.hasChallenger||e.hasResist}modifyWeightByKeywords(e,t){const i=[{key:"hasBodyguard",modifier:1.1},{key:"hasEvasive",modifier:1.2},{key:"hasRush",modifier:1.05},{key:"hasWard",modifier:1.05},{key:"hasSinger",modifier:1.3},{key:"hasBoost",modifier:1.1},{key:"hasReckless",modifier:.95},{key:"hasChallenger",modifier:1+e.challengerAmount/10},{key:"hasResist",modifier:1+e.resistAmount/10}];for(const s of i)e[s.key]&&(t*=s.modifier);return t}modifyWeightByDeckType(e,t,i){if("default"===i)return t;if(e.cost<=3){const i=[{text:"banish",modifier:1.4},{text:"banish all",modifier:1.4},{text:"return",modifier:1.7},{text:"into your inkwell",modifier:1.05}];for(const s of i)e.sanitizedText.includes(s.text)&&(t*=s.modifier)}return e.lore>1&&(t*=1+e.lore/10),t}}class n{constructor(e,t){this.weightCalculator=t,this.cards=e,this.currentDistribution=null,this.useDefaultDistribution(),this.initializeCardRequirements()}useAggroDistribution(){this.currentDistribution={1:12,2:20,3:12,4:8,5:8}}useDefaultDistribution(){this.currentDistribution={1:8,2:12,3:20,4:12,5:8}}initializeCardRequirements(){for(const e in this.cards){const t=this.cards[e].sanitizedText;if(null==t||""===t)continue;const i=/gains? \w+(\s\+\d)?/g,s=t.replace(i,"");for(const t of this.keywords)s.includes(t.toLowerCase())&&this.cards[e].requiredKeywords.push(t);for(const i of this.classifications){let s=`challenges a ${i.toLowerCase()}`;t.replace(s,"").includes(i.toLowerCase())&&this.cards[e].requiredClassifications.push(i)}for(const i of this.types)if("Character"!==i)if("Item"!==i)t.includes(i.toLowerCase())&&this.cards[e].requiredTypes.push(i);else{const s=/(?:chosen item of yours|your items?|reveal an item)/g;t.match(s)&&this.cards[e].requiredTypes.push(i)}for(const i of this.cardNames)t.includes(` ${i.toLowerCase()}`)&&this.cards[e].requiredCardNames.push(i);if(this.cards[e].hasShift){let t=[this.cards[e].name];this.cards[e].name.includes("&")&&(t=this.cards[e].name.split("&").map((e=>e.trim()))),this.cards[e].requiredCardNames.push(...t)}this.cards[e].requiredKeywords=[...new Set(this.cards[e].requiredKeywords)],this.cards[e].requiredClassifications=[...new Set(this.cards[e].requiredClassifications)],this.cards[e].requiredTypes=[...new Set(this.cards[e].requiredTypes)],this.cards[e].requiredCardNames=[...new Set(this.cards[e].requiredCardNames)]}}get keywords(){return["Ward","Evasive","Bodyguard","Resist","Singer","Shift","Reckless","Challenger","Rush"]}get classifications(){return[...new Set(this.cards.map((e=>e.classifications)).flat())]}get types(){return[...new Set(this.cards.map((e=>e.types)).flat())]}get cardNames(){return[...new Set(this.cards.map((e=>e.name)))]}generateDeck(e,t=[],i="default",s=50){console.log(`Generating ${i} deck, ${s} tries remaining`);const r=this.cards.filter((t=>{if(1===t.inks.length&&e.includes(t.inks[0]))return!0;let i=!0;for(const s of e)if(!t.inks.includes(s)){i=!1;break}return i}));if(0===r.length)return[];do{let e=this.pickRandomCard(r,t,i,s);t.push(e)}while(!this.isDeckValid(t));return s>=0&&(s--,t=this.validateAndRetry(t,i,s)),t}pickRandomCost(e){const t={1:this.currentDistribution[1]-e.filter((e=>1===e.cost)).length,2:this.currentDistribution[2]-e.filter((e=>2===e.cost)).length,3:this.currentDistribution[3]-e.filter((e=>3===e.cost)).length,4:this.currentDistribution[4]-e.filter((e=>4===e.cost)).length,5:this.currentDistribution[5]-e.filter((e=>e.cost>=5)).length},i=Object.values(t).reduce(((e,t)=>e+t),0),s=Math.random()*i;let r=0,n=null;for(const e in t)if(r+=t[e],r>=s){n=e;break}return parseInt(n)}pickRandomCard(e,t,i,s){const r=this.pickRandomCost(t);let n=e.filter((e=>5===r?e.cost>=r:e.cost===r)).filter((e=>(console.log(e),"legal"===e.legality))).map((e=>({card:e,weight:this.weightCalculator.calculateWeight(e,t,i,s)}))).filter((e=>e.weight>0));n=n.filter((e=>t.filter((t=>t.id===e.card.id)).length<4));const o=n.reduce(((e,t)=>e+t.weight),0),d=Math.floor(Math.random()*o);let a=0,c=null;for(const e of n)if(a+=e.weight,a>=d){c=e.card;break}return c}isDeckValid(e){return e.length>=60}validateAndRetry(e,t,i){let s=e.length,r=s=null;do{console.log("Removing cards without requirements"),r=s,s=(e=this.removeCardsWithoutRequirements(e)).length}while(s!==r);const n=e.filter((t=>1===e.filter((e=>e.id===t.id)).length));if(n.length>4){console.log("Removing cards with single copy");for(const t of n)console.log(`Removing ${t.title} with single copy`),s=(e=e.filter((e=>e.id!==t.id))).length}return 60===s?e:this.generateDeck(e.map((e=>e.ink)),e,t,i)}removeCardsWithoutRequirements(e){const t=[];for(const i of e)t.includes(i)||t.push(i);for(const i of t)this.cardHasMissingRequirements(i,t)&&(i.deckMeetsRequiredKeywords(e),i.deckMeetsRequiredClassifications(e),i.deckMeetsRequiredTypes(e),i.deckMeetsRequiredCardNames(e),i.deckMeetsShiftRequirements(e),e=e.filter((e=>e.id!==i.id)));return e}cardHasMissingRequirements(e,t){return!e.deckMeetsRequirements(t)}}var o=i(814),d=i(795),a=i(479),c=i(844);class h{constructor(e,t,i,s,r,n,h,l,u){this.deck=[],this.inks=[],this.deckGenerator=e,this.loadingScreen=t,this.generateDeckButtons=i,this.testDeckButton=s,this.clearDeckButton=r,this.deckContainer=n,this.dialogContainer=h,this.cardSelectContainer=l,this.chart=u,this.cardPreview=new c.A,this.deckRenderer=new o.A(this.deckContainer,{onRemove:e=>this.removeCard(e),onAdd:()=>this.cardSelector.show(),onCardClick:e=>this.cardPreview.show(e.image,e.name),isEditable:!0,showAddPlaceholder:!0}),this.cardSelector=new d.A(this.deckGenerator.cards,this.cardSelectContainer,(e=>this.addCardToDeck(e)),{filter:e=>this.filterCard(e),sort:(e,t)=>this.sortCards(e,t),renderButtonText:e=>this.renderButtonText(e)}),this.inkSelector=new a.A(document.querySelector('[data-role="ink-selector"]'),{onChange:e=>this.updateInks(e)}),this.init()}init(){this.addListeners(),this.loadingScreen.close()}addListeners(){this.generateDeckButtons.forEach((e=>{e.addEventListener("click",(()=>{this.loadingScreen.show();let t="default";switch(e.dataset.distribution){case"default":this.deckGenerator.useDefaultDistribution();break;case"aggro":t="aggro",this.deckGenerator.useAggroDistribution()}this.deck=this.deckGenerator.generateDeck(this.inks,this.deck,t),this.renderDeck(),this.chart.renderChart(this.deck),setTimeout((()=>this.loadingScreen.close()),1e3)}))})),this.clearDeckButton.addEventListener("click",(()=>{this.deck=[],this.renderDeck(),this.chart.renderChart(this.deck)})),this.testDeckButton.addEventListener("click",(()=>{window.open(this.inkTableLink,"_blank")}))}updateInks(e){this.inks=e,this.removeCardsFromWrongInk(),this.cardSelector.refresh()}filterCard(e){return!(!this.inks.includes(e.ink)&&!this.checkDualInks(e))&&this.deck.filter((t=>t.id===e.id)).length<4}checkDualInks(e){return 2===this.inks.length&&this.inks.includes(e.inks[0])&&this.inks.includes(e.inks[1])}sortCards(e,t){if(e.ink!==t.ink)return this.inks.indexOf(e.ink)-this.inks.indexOf(t.ink);const i=["Character","Action","Item","Location"];return e.types[0]!==t.types[0]?i.indexOf(e.types[0])-i.indexOf(t.types[0]):e.cost!==t.cost?e.cost-t.cost:e.title<t.title?-1:1}renderButtonText(e){return`Add card <small>(${this.deck.filter((t=>t.id===e.id)).length}/4)</small>`}addCardToDeck(e){this.deck.push(e),this.renderDeck(),this.cardSelector.refresh(),this.chart.renderChart(this.deck),60===this.deck.length&&this.cardSelector.hide()}removeCard(e){const t=this.deck.findIndex((t=>t.id===e));-1!==t&&this.deck.splice(t,1),this.renderDeck(),this.cardSelector.refresh(),this.chart.renderChart(this.deck)}removeCardsFromWrongInk(){this.deck=this.deck.filter((e=>this.inks.includes(e.ink))),this.renderDeck(),this.chart.renderChart(this.deck)}renderDeck(){this.deckRenderer.render(this.deck,this.inks),this.testDeckButton.classList.remove("hidden"),this.generateDeckButtons.forEach((e=>e.classList.add("hidden"))),this.deck.length<60&&(this.testDeckButton.classList.add("hidden"),this.generateDeckButtons.forEach((e=>e.classList.remove("hidden"))))}get inkTableLink(){const e=Math.random().toString(36).substring(7);let t=`Generated Deck: ${this.inks[0]} - ${this.inks[1]} - ${e}`;t=encodeURIComponent(t);let i="";const s=[...new Set(this.deck.map((e=>e.title)))];for(const e of s){const t=this.deck.filter((t=>t.title===e)).length;i+=`${e}$${t}|`}return`https://inktable.net/lor/import?svc=dreamborn&name=${t}&id=${btoa(i)}`}}var l=i(238);document.addEventListener("DOMContentLoaded",(async()=>{const e=new s.A,t=await e.getCards(),i=new r,o=new n(t,i),d=new l.A(document.querySelector("[data-role=chart]")),a=document.querySelector("[data-role=loading]");a.show(),new h(o,a,document.querySelectorAll("[data-role=generator]"),document.querySelector("[data-role=test]"),document.querySelector("[data-role=clear]"),document.querySelector("[data-role=deck]"),document.querySelector("[data-role=card-preview]"),document.querySelector("[data-role=card-select]"),d)}))}},e=>{e.O(0,[839,452],(()=>e(e.s=139))),e.O()}]);